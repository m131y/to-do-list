<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>To Do List</title>
    <link rel="stylesheet" th:href="@{/styles.css}"/>
</head>
<body>
<div class="container">
    <h1>To Do List</h1>
    <form th:action="@{/todos}" method="post" class="todo-form" onsubmit="return validateForm()">
        <div class="top-row">
            <div class="color-picker" style="margin-bottom: 10px;">
                <label>
                    <input type="radio" name="color" value="#FF7171" />
                    <span class="color-box" style="background-color: #FF7171;"></span>
                </label>
                <label>
                    <input type="radio" name="color" value="#6f99de" />
                    <span class="color-box" style="background-color: #6f99de;"></span>
                </label>
                <label>
                    <input type="radio" name="color" value="#0caf6377" />
                    <span class="color-box" style="background-color: #0caf6377;"></span>
                </label>
                <label>
                    <input type="radio" name="color" value="#F5D971" />
                    <span class="color-box" style="background-color: #F5D971;"></span>
                </label>
            </div>
            <div class="date-inputs">
                <input type="date" name="taskStartDate" placeholder="StartDate" required/>
                <input type="date" name="taskEndDate" placeholder="StartDate" required/>
            </div>
        </div>
        <div class="bottom-row">
            <input type="text" name="task" placeholder="Enter a new task" required />
            <button type="submit">Ìà¨Îëê Ï∂îÍ∞Ä</button>
        </div>
    </form>

    <form method="get" action="/todos">
        <select name="sort" onchange="this.form.submit()">
            <option value="created" th:selected="${sort == 'created'}">Îì±Î°ùÏàú</option>
            <option value="start" th:selected="${sort == 'start'}">ÏãúÏûëÏùºÏàú</option>
            <option value="color" th:selected="${sort == 'color'}">ÏÉâÏÉÅÎ≥Ñ</option>
        </select>
    </form>

    <div class="todo-list">
        <ul>
            <li th:each="task : ${todos}" >
                <div class="task-left">
                    <label class="checkbox-wrapper">
                        <form th:action="@{/todos/toggle}" method="post" style="display:inline;">
                            <input type="hidden" name="taskId" th:value="${task.id}"/>
                            <input type="hidden" name="sort" th:value="${sort}" />
                            <input type="checkbox" onclick="this.form.submit()" th:checked="${task.completed}"/>
                            <span class="custom-check"
                                  th:style="'border:2px solid ' + (${task.color} != null ? ${task.color} : '#ccc') + ';' +
                                            (${task.completed} and ${task.color} != null ? 'background-color:' + ${task.color} : '')">
                            </span>

                            <!--inputÏúºÎ°ú Ïù¥ formÏùÑ submitÌï† Ïàò ÏûàÍ≤å Ìï¥Ï§å-->
                        </form>
                    </label>

                    <span th:text="${task.description}"> </span>
                </div>
                <div th:if="${task.taskStartDate == task.taskEndDate}">
                    <span th:text="${task.taskStartDate}"></span>
                </div>
                <div th:if="${task.taskStartDate != task.taskEndDate}">
                    <span th:text="${task.taskStartDate}"></span>
                    <span>~</span>
                    <span th:text="${task.taskEndDate}"></span>
                </div>
                <div class="task-right">
                    <div class="kebab-menu-wrapper">
                        <!-- ÏºÄÎ∞• Î≤ÑÌäº -->
                        <button class="kebab-btn" onclick="toggleMenu(this)">‚ãÆ</button>

                        <!-- ÌåùÏóÖ Î©îÎâ¥ -->
                        <div class="kebab-menu hidden">
                            <form th:action="@{/todos/update}" method="post">
                                <input type="hidden" name="taskId" th:value="${task.id}"/>
                                <input type="text" name="newDescription" placeholder="Edit task" required/>
                                <button type="submit">Edit</button>
                            </form>

                            <form th:action="@{/todos/delete}" method="post">
                                <input type="hidden" name="taskId" th:value="${task.id}"/>
                                <button type="submit">Delete</button>
                            </form>
                        </div>
                    </div>
                </div>
            </li>
            <span>
            </span>
        </ul>

    </div>

</div>

<script>
    function toggleMenu(button) {
        const menu = button.nextElementSibling;
        const allMenus = document.querySelectorAll('.kebab-menu');
        allMenus.forEach(m => {
            if (m !== menu) m.classList.add('hidden');
        });
        menu.classList.toggle('hidden');
    }

    // Î∞îÍπ• ÌÅ¥Î¶≠ Ïãú Î©îÎâ¥ Îã´Í∏∞
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.kebab-menu-wrapper')) {
            document.querySelectorAll('.kebab-menu').forEach(menu => menu.classList.add('hidden'));
        }
    });


    function validateForm() {
        const color = document.querySelector('input[name="color"]:checked');
        const startDate = document.querySelector('input[name="taskStartDate"]').value;
        const endDate = document.querySelector('input[name="taskEndDate"]').value;

        // üî¥ ÏÉâ ÏÑ†ÌÉù Ïïà ÌñàÏùÑ Îïå
        if (!color) {
          alert("ÏÉâÏÉÅÏùÑ ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî!");
          return false;
        }

        // üî¥ ÏãúÏûëÏùº, Ï¢ÖÎ£åÏùºÏù¥ Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÑ Îïå
        if (startDate > endDate) {
          alert("ÏãúÏûëÏùºÏùÄ Ï¢ÖÎ£åÏùºÎ≥¥Îã§ Îπ†Î•¥Í±∞ÎÇò Í∞ôÏïÑÏïº Ìï©ÎãàÎã§!");
          return false;
        }

        // ÌÜµÍ≥º!
        return true;
    }
</script>

</body>
</html>